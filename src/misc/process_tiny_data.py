import random

from datasets import load_dataset
from huggingface_hub import HfFileSystem

from data.tokenizer import parse_game, tokenize_game

fs = HfFileSystem()

parquet_files = fs.glob("datasets/Lichess/standard-chess-games/**/*.parquet")

data_files = [f"hf://{p}" for p in random.Random(42).sample(parquet_files, 10)]
ds = load_dataset("parquet", data_files=data_files, split="train")
# Load bucket weights for downsampling

format_sampling = {
    "Rated Bullet": 0.014813146964193662,
    "Rated Rapid": 0.1667055646317474,
    "Rated UltraBullet": 0.25,
    "Rated Blitz": 0.042171316757194426,
}
elo_sampling = {
    (2100, 2100): 0.10256410256410256,
    (1500, 1400): 0.04608294930875576,
    (1400, 1400): 0.0178826895565093,
    (1100, 1100): 0.0385951370127364,
    (1800, 1900): 0.06983240223463687,
    (1700, 1600): 0.049443757725587144,
    (2000, 2100): 0.16168148746968472,
    (1800, 1800): 0.022237046920169,
    (1200, 1200): 0.026140373807345445,
    (2100, 2000): 0.1631321370309951,
    (1500, 1500): 0.013587879611386643,
    (1300, 1300): 0.020092425155716295,
    (1700, 1800): 0.055975370836831795,
    (1000, 1000): 0.06018657839301836,
    (1900, 1800): 0.07163323782234957,
    (1900, 1700): 0.23391812865497075,
    (1300, 1600): 0.3466204506065858,
    (700, 700): 0.9090909090909091,
    (1600, 1600): 0.01614465611882467,
    (1000, 1100): 0.1142204454597373,
    (2000, 2000): 0.054629882545752524,
    (1700, 1700): 0.01751927119831815,
    (1900, 2000): 0.10325245224574084,
    (1400, 1800): 0.6734006734006734,
    (1300, 1100): 0.35335689045936397,
    (1800, 2100): 0.9216589861751152,
    (1700, 1900): 0.23446658851113716,
    (1000, 900): 0.17482517482517482,
    (2300, 2300): 0.45558086560364464,
    (1900, 1900): 0.03309614429918915,
    (1800, 1700): 0.05518763796909492,
    (1300, 1400): 0.05793742757821553,
    (900, 900): 0.13071895424836602,
    (1500, 1200): 0.3861003861003861,
    (1500, 1900): 0.6329113924050633,
    (1200, 1000): 0.437636761487965,
    (2000, 1900): 0.1027221366204417,
    (1400, 1200): 0.27434842249657065,
    (1400, 1500): 0.04716981132075472,
    (1100, 1200): 0.08463817181548879,
    (1800, 1600): 0.21810250817884405,
    (1200, 1300): 0.0676818950930626,
    (2100, 2200): 0.29895366218236175,
    (1200, 1600): 0.7782101167315175,
    (1700, 1500): 0.18018018018018017,
    (1500, 1600): 0.04549590536851683,
    (900, 1000): 0.17452006980802792,
    (1200, 1100): 0.08514261387824607,
    (1400, 1300): 0.05605381165919283,
    (1000, 1200): 0.4444444444444444,
    (2200, 2200): 0.20768431983385255,
    (800, 900): 0.35335689045936397,
    (1600, 1700): 0.05060728744939271,
    (1600, 1500): 0.04503490204908804,
    (2000, 1800): 0.315955766192733,
    (1300, 1200): 0.06842285323297982,
    (800, 800): 0.33277870216306155,
    (1100, 1000): 0.10922992900054615,
    (900, 800): 0.34071550255536626,
    (1100, 900): 0.5681818181818182,
    (900, 1100): 0.5509641873278237,
    (2100, 1800): 0.7782101167315175,
    (2300, 2200): 0.5524861878453039,
    (1500, 1300): 0.1768346595932803,
    (1400, 1600): 0.2012072434607646,
    (1300, 1500): 0.18467220683287167,
    (2100, 1900): 0.4175365344467641,
    (1900, 2100): 0.4032258064516129,
    (1600, 1800): 0.20366598778004075,
    (1300, 1000): 0.8928571428571429,
    (1500, 1800): 0.351493848857645,
    (1200, 1500): 0.3875968992248062,
    (1100, 1500): 0.7843137254901961,
    (1700, 2000): 0.6230529595015576,
    (1800, 1500): 0.3436426116838488,
    (1700, 1200): 0.9259259259259259,
    (2200, 2300): 0.5763688760806917,
    (1500, 1700): 0.16806722689075632,
    (2400, 2400): 0.9302325581395349,
    (1100, 1400): 0.7434944237918215,
    (1100, 1300): 0.37593984962406013,
    (2200, 2100): 0.30721966205837176,
    (1600, 1900): 0.4830917874396135,
    (1400, 1700): 0.40080160320641284,
    (1600, 1400): 0.1998001998001998,
    (700, 800): 0.9852216748768473,
    (1400, 1100): 0.7017543859649122,
    (1700, 1400): 0.398406374501992,
    (1000, 800): 0.8403361344537815,
    (1700, 1300): 0.684931506849315,
    (1600, 1300): 0.32679738562091504,
    (1900, 1600): 0.4819277108433735,
    (800, 1000): 0.966183574879227,
    (2000, 2200): 0.7142857142857143,
    (1800, 2000): 0.28776978417266186,
    (1200, 1700): 0.8888888888888888,
    (1200, 1400): 0.29027576197387517,
    (2000, 1700): 0.6024096385542169,
    (1600, 1200): 0.6968641114982579,
    (1300, 1700): 0.6688963210702341,
    (1000, 1300): 0.8333333333333334,
    (1900, 1500): 0.6644518272425249,
    (1800, 1400): 0.6968641114982579,
    (1600, 2000): 0.9803921568627451,
    (2200, 2000): 0.7272727272727273,
    (1500, 1100): 0.7936507936507936,
}


def get_elo_bucket(elo: int) -> int:
    """Get the ELO bucket range for a given ELO rating."""
    bucket = elo // 100 * 100
    return bucket


def filter_by_format(game: dict):
    format = " ".join(game["Event"].split(" ")[:2])
    return format.startswith("Rated ") and random.random() < format_sampling.get(format, 1.0)


def filter_by_elo(game: dict):
    white_bucket = get_elo_bucket(game["WhiteElo"])
    black_bucket = get_elo_bucket(game["BlackElo"])
    return random.random() < elo_sampling.get((white_bucket, black_bucket), 1.0)


def should_keep_game(game: dict) -> bool:
    """Determine if a game should be kept based on bucket weights."""
    return filter_by_format(game) and filter_by_elo(game)


def process_game(game: dict) -> dict:
    """Process a game by parsing and tokenizing it."""
    parsed = parse_game(game)
    tokens = tokenize_game(parsed)
    return {"tokens": tokens}


ds_filtered = ds.filter(should_keep_game, num_proc=32)
# Process the filtered games
ds_processed = ds_filtered.map(process_game, num_proc=32)
ds_processed.push_to_hub("yimingzhang/tmp")

print(f"After filtering: {len(ds_filtered)} games (from {len(ds)})")
